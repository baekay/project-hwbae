<?xml version="1.0" encoding="euc-kr"?>
<!--
품질자동검증 테스트 결과 관리 용 SQL XML 파일

@sfmi.title 품질자동검증 테스트 결과 관리 용 SQL XML 파일
@sfmi.portal-id jk420.kim
@sfmi.developer 박현준
-->
<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="AutoValidationTestResult">
    <typeAlias alias="testProcess" type="sfmi.component.squad.itqualitybdt.TestProcess"/>
    <typeAlias alias="testExecInfo" type="sfmi.component.squad.itqualitybdt.TestExecInfo"/>
    <typeAlias alias="autoValidationTestExecInfo" type="sfmi.component.squad.itqualitybdt.AutoValidationTestExecInfo"/>
    <typeAlias alias="autoValidationTestExecResult" type="sfmi.component.squad.itqualitybdt.AutoValidationTestExecResult"/>
    <typeAlias alias="autoValidationTarget" type="sfmi.component.squad.itqualitybdt.AutoValidationTarget"/>


    <parameterMap class="autoValidationTestExecResult" id="autoValidationTestExecResultParam">
        <parameter property="subSrId" />
        <parameter property="actvId" />
        <parameter property="filePath" />
        <parameter property="fileNm" />
        <parameter property="fileVer" />
        <parameter property="verifReqDateSi" />
        <parameter property="autoValidationTypeCodeVal" />
        <parameter property="execDttm" />
        <parameter property="execResult" />
        <parameter property="inputClerk" />
    </parameterMap>
	
	<!--
                품질자동 검증 결과 조회 (보안취약성)
     -->
    <select id="selectAutoValidationTestExecResultCount" parameterClass="autoValidationTestExecResult" resultClass="java.lang.Integer">
		SELECT COUNT(1) FROM DPQA19TB
		WHERE FK_SUB_SR_ID=#subSrId#
		  AND FK_ACTV_ID=#actvId#
		  AND FK_FILE_PATH=#filePath#
		  AND FK_FILE_NM=#fileNm#
		  AND FK_FILE_VER=#fileVer#
		  AND FK_VERIF_REQ_DATE_SI = #verifReqDateSi#
		  AND QLT_VERIF_TYPE = #autoValidationTypeCodeVal#
		  AND EXCT_DTTM = #execDttm#
    </select>
    
    <!--
                품질 자동검증 결과 업데이트
     -->
    <update id="updateAutoValidationTestExecResult" parameterClass="autoValidationTestExecResult">
	    UPDATE DPQA19TB
	    	SET EXCT_RSLT = DECODE(EXCT_RSLT, 'Q0801', #execResult#, EXCT_RSLT)
		WHERE FK_SUB_SR_ID=#subSrId#
		  AND FK_ACTV_ID=#actvId#
		  AND FK_FILE_PATH=#filePath#
		  AND FK_FILE_NM=#fileNm#
		  AND FK_FILE_VER=#fileVer#
		  AND FK_VERIF_REQ_DATE_SI = #verifReqDateSi#
		  AND QLT_VERIF_TYPE = #autoValidationTypeCodeVal#
		  AND EXCT_DTTM = #execDttm#
    </update>
	
    <!--
                품질자동 검증 결과 저장
     -->
    <insert id="insertAutoValidationTestExecResult" parameterMap="autoValidationTestExecResultParam">
        INSERT INTO DPQA19TB (
            FK_SUB_SR_ID, FK_ACTV_ID, FK_FILE_PATH,
            FK_FILE_NM, FK_FILE_VER, FK_VERIF_REQ_DATE_SI,
            QLT_VERIF_TYPE, EXCT_DTTM, EXCT_RSLT,
        INPUT_CLERK, INPUT_DTTM)
        VALUES (
        ?, ?, ?,
        ?, ?, ?,
        ?, ?, ?,
        ?,to_char(sysdate,'yyyyMMddHH24miss')
        )
    </insert>

	<!--
                품질자동 검증 결과 삭제 (데이터품질)
     -->
    <delete id="deleteAutoValidationTestExecResult" parameterClass="autoValidationTestExecResult">
		DELETE FROM DPQA19TB
		WHERE FK_SUB_SR_ID=#subSrId#
		  AND FK_ACTV_ID=#actvId#
		  AND FK_FILE_PATH=#filePath#
		  AND FK_FILE_NM=#fileNm#
		  AND FK_FILE_VER=#fileVer#
		  AND QLT_VERIF_TYPE='Q0704'
    </delete>

    <!--
      SR,활동ID별 파일정보 품질 자동 검증 결과 업데이트
     -->
    <update id="updateAutoValidatonTestExecOverallResult" parameterClass="autoValidationTestExecInfo">
        UPDATE DPQA17TB
        SET VERIF_OVLL_RSLT = #verifOvllRslt#
        WHERE SUB_SR_ID = #subSrId#
          AND ACTV_ID = #actvId#
          AND FILE_PATH = #filePath#
          AND FILE_NM = #fileNm#
    </update>

    <!--
                파일 버전 별 품질 자동검증 결과 업데이트
     -->
    <update id="updateAutoValidatonTestExecResult" parameterClass="autoValidationTestExecInfo">
	    UPDATE DPQA18TB
	    SET VERIF_RSLT = #verifRslt#
	    WHERE FK_SUB_SR_ID = #subSrId#
	    AND FK_ACTV_ID = #actvId#
	    AND FK_FILE_PATH = #filePath#
	    AND FK_FILE_NM = #fileNm#
	    AND FILE_VER = #fileVer#
	    AND VERIF_REQ_DATE_SI = #verifReqDateSi#
    </update>
    
    
    <!--
                프로젝트 품질자동 검증 결과 조회 (보안취약성)
     -->
    <select id="selectAutoValidationTestExecResultForProjectCount" parameterClass="autoValidationTestExecResult" resultClass="java.lang.Integer">
		SELECT COUNT(1) FROM DPQA16TB
		WHERE FK_SUB_SR_ID=#subSrId#
		  AND FK_ACTV_ID=#actvId#
		  AND FK_FILE_PATH=#filePath#
		  AND FK_FILE_NM=#fileNm#
		  AND FK_FILE_VER=#fileVer#
		  AND FK_VERIF_REQ_DATE_SI = #verifReqDateSi#
		  AND QLT_VERIF_TYPE = #autoValidationTypeCodeVal#
		  AND EXCT_DTTM = #execDttm#
    </select>
    
    <!--
                프로젝트품질 자동검증 결과 업데이트
     -->
    <update id="updateAutoValidationTestExecResultForProject" parameterClass="autoValidationTestExecResult">
	    UPDATE DPQA16TB
	    	SET EXCT_RSLT = DECODE(EXCT_RSLT, 'Q0801', #execResult#, EXCT_RSLT)
		WHERE FK_SUB_SR_ID=#subSrId#
		  AND FK_ACTV_ID=#actvId#
		  AND FK_FILE_PATH=#filePath#
		  AND FK_FILE_NM=#fileNm#
		  AND FK_FILE_VER=#fileVer#
		  AND FK_VERIF_REQ_DATE_SI = #verifReqDateSi#
		  AND QLT_VERIF_TYPE = #autoValidationTypeCodeVal#
		  AND EXCT_DTTM = #execDttm#
    </update>

    <!--
                프로젝트 품질자동 검증 결과 저장
     -->
    <insert id="insertAutoValidationTestExecResultForProject" parameterMap="autoValidationTestExecResultParam">
        INSERT INTO DPQA16TB (
            FK_SUB_SR_ID, FK_ACTV_ID, FK_FILE_PATH,
            FK_FILE_NM, FK_FILE_VER, FK_VERIF_REQ_DATE_SI,
            QLT_VERIF_TYPE, EXCT_DTTM, EXCT_RSLT,
        INPUT_CLERK, INPUT_DTTM)
        VALUES (
        ?, ?, ?,
        ?, ?, ?,
        ?, ?, ?,
        ?,to_char(sysdate,'yyyyMMddHH24miss')
        )
    </insert>

    <!--
      SR,활동ID별 파일정보 프로젝트 품질 자동 검증 결과 업데이트
     -->
    <update id="updateAutoValidatonTestExecOverallResultForProject" parameterClass="autoValidationTestExecInfo">
        UPDATE DPQA14TB
        SET VERIF_OVLL_RSLT = #verifOvllRslt#
        WHERE SUB_SR_ID = #subSrId#
          AND ACTV_ID = #actvId#
          AND FILE_PATH = #filePath#
          AND FILE_NM = #fileNm#
    </update>

    <!--
                파일 버전 별 프로젝트품질 자동검증 결과 업데이트
     -->
    <update id="updateAutoValidatonTestExecResultForProject" parameterClass="autoValidationTestExecInfo">
	    UPDATE DPQA15TB
	    SET VERIF_RSLT = #verifRslt#
	    WHERE FK_SUB_SR_ID = #subSrId#
	    AND FK_ACTV_ID = #actvId#
	    AND FK_FILE_PATH = #filePath#
	    AND FK_FILE_NM = #fileNm#
	    AND FILE_VER = #fileVer#
	    AND VERIF_REQ_DATE_SI = #verifReqDateSi#
    </update>
    
    <!--
                품질자동 검증 조회 (보안취약성)
     -->
    <select id="selectAutoValidationCount" parameterClass="autoValidationTestExecResult" resultClass="java.lang.Integer">
		SELECT 
			COUNT(1) 
		FROM DPQA17TB
		WHERE SUB_SR_ID = #subSrId#
      	  AND ACTV_ID = #actvId#
          AND FILE_PATH = #filePath#
      	  AND FILE_NM = #fileNm#
    </select>
    <!--
                보안취약성 검증 중 SR별파일내역이 없을때 저장.
     -->
    <insert id="createAutoValidationInfo" parameterClass="autoValidationTestExecResult">
	    INSERT INTO DPQA17TB(
	      SUB_SR_ID, ACTV_ID, FILE_PATH, FILE_NM, FILE_OWNER_PORTAL_ID,
	      FILE_LAST_CI_DTTM, VERIF_OVLL_RSLT, INPUT_CLERK, INPUT_DTTM)
	    VALUES(
	      #subSrId#, #actvId#, #filePath#, #fileNm#, #inputClerk#,
	      #verifReqDateSi#, #execResult#, #inputClerk#, to_char(sysdate,'yyyyMMddHH24miss'))
    </insert>
    
    <update id="updateAutoValidationInfo" parameterClass="autoValidationTestExecResult">     
		UPDATE DPQA17TB
        	SET VERIF_OVLL_RSLT = DECODE(FILE_LAST_CI_DTTM, #verifReqDateSi#, DECODE(VERIF_OVLL_RSLT, 'Q0801', #execResult#, VERIF_OVLL_RSLT ), #execResult#)
        WHERE SUB_SR_ID = #subSrId#
          AND ACTV_ID = #actvId#
          AND FILE_PATH = #filePath#
          AND FILE_NM = #fileNm#              
	</update>
	
	<!--
                프로젝트 품질자동 검증 조회 (보안취약성)
     -->
    <select id="selectAutoValidationCountForProject" parameterClass="autoValidationTestExecResult" resultClass="java.lang.Integer">
		SELECT 
			COUNT(1) 
		FROM DPQA14TB
		WHERE SUB_SR_ID = #subSrId#
      	  AND ACTV_ID = #actvId#
          AND FILE_PATH = #filePath#
      	  AND FILE_NM = #fileNm#
    </select>
    <!--
                프로젝트 보안취약성 검증 중 SR별파일내역이 없을때 저장.
     -->
    <insert id="createAutoValidationInfoForProject" parameterClass="autoValidationTestExecResult">
	    INSERT INTO DPQA14TB(
	      SUB_SR_ID, ACTV_ID, FILE_PATH, FILE_NM, FILE_OWNER_PORTAL_ID,
	      FILE_LAST_CI_DTTM, VERIF_OVLL_RSLT, INPUT_CLERK, INPUT_DTTM)
	    VALUES(
	      #subSrId#, #actvId#, #filePath#, #fileNm#, #inputClerk#,
	      #verifReqDateSi#, #execResult#, #inputClerk#, to_char(sysdate,'yyyyMMddHH24miss'))
    </insert>
    
    <update id="updateAutoValidationInfoForProject" parameterClass="autoValidationTestExecResult">     
		UPDATE DPQA14TB
        	SET VERIF_OVLL_RSLT = DECODE(FILE_LAST_CI_DTTM, #verifReqDateSi#, DECODE(VERIF_OVLL_RSLT, 'Q0801', #execResult#, VERIF_OVLL_RSLT ), #execResult#)
        WHERE SUB_SR_ID = #subSrId#
          AND ACTV_ID = #actvId#
          AND FILE_PATH = #filePath#
          AND FILE_NM = #fileNm#              
	</update>

    <!--
                파일별 추출한 고객보안 항목을 ILM 시스템에 저장
     -->
    <insert id="createCustomerSecurityResult" parameterClass="autoValidationTarget">
		INSERT INTO TB_CUST_SECU_FILE@ILM (
		    WORK_DATE, SEQ_NO,
		    FILE_NAME, REL_PATH, VER_NO, CI_TIME,
		    ACTIVE_ID,PORTAL_ID, SR_NO, SR_NAME, 
		    CUST_ATTR, STS, CREATE_DATE)
		VALUES (
			TO_CHAR(SYSDATE,'YYYYMMDD'), (SELECT NVL(MAX(SEQ_NO),0)+1 FROM TB_CUST_SECU_FILE@ILM WHERE WORK_DATE=TO_CHAR(SYSDATE,'YYYYMMDD')), 
			#fileName#, #location#, #version#, #verifReqDateSi#,
			#activityId#, #ownerId#, #subSrId#, (SELECT SR_DOCU_TITLE FROM CSYST100T WHERE SR_NO=SUBSTR(#subSrId#,1,12)),
			#customerSecurity#, 'R', SYSDATE)
    </insert>
</sqlMap>